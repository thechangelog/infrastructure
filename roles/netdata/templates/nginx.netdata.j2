#/* vim: set ft=cfg : */

server {
  listen 80;
  server_name {{ fqdn }};
  return 301 https://{{ fqdn }}$request_uri;
}

upstream netdata {
  server {{ ansible_host }}:19999;
  keepalive 64;
}

server {
  listen 443 ssl http2;
  server_name {{ fqdn }};

  ssl on;
  ssl_certificate /etc/nginx/ssl/star.changelog.com.crt;
  ssl_certificate_key /etc/nginx/ssl/star.changelog.com.key;
  ssl_trusted_certificate /etc/nginx/ssl/star.changelog.com.fullchain.pem;

  location / {
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Server $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://netdata;
    proxy_http_version 1.1;
    proxy_pass_request_headers on;
    proxy_set_header Connection "keep-alive";
    proxy_store off;
  }

  include /etc/nginx/conf.d/disable_favicon_logging.server;
  include /etc/nginx/conf.d/disable_robots_logging.server;
  include /etc/nginx/conf.d/disable_hidden.server;
}
